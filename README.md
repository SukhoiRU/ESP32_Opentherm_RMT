# ESP32_OpenTherm_RTM

Версия 1.0

Собственная программа для [SmartTherm32](https://www.umkikit.ru/index.php?route=product/product&path=67&product_id=103)

## Используемые библиотеки:
* [JSON for Modern C++](https://github.com/nlohmann/json)
* Стандартные компоненты onewire_bus и ds18b20 от [espressif](https://components.espressif.com)

## Особенности:
* Полностью своя реализация протокола OpenTherm 2.2 с использованием аппаратных средств [RMT](https://docs.espressif.com/projects/esp-idf/en/stable/esp32/api-reference/peripherals/rmt.html#rmt-rmt-encoder)
* Полностью своя реализация [Telegram bot API](https://core.telegram.org/bots/api) для мониторинга, управления, сбора логов и прошивки OTA
* Работа с брокером MQTT
* TCP-сервер для взаимодействия с web-сервером, работающим на Raspberry Pi 4

## Сборка
* Проект собирается на чистом [ESP-IDF](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/). Проверено на версии 5.3.1 для WROOM-32, остальное не пробовал.
* Файл secure_config_template.h необходимо переименовать в secure_config.h, заполнив форму своими данными.

## Реализация OpenTherm на RMT

Типовые библиотеки OpenTherm, работающие на физическом уровне по принципу Arduino, меня не устраивали по причине большого количества ошибок обмена с котлом. Примерно 1 сбой на 1000 секунд работы. К тому же, ручное использование delay и прерываний на контроллере, имеющем аппаратную поддержку различных интерфейсов, мягко говоря, выглядит странно.
Линия у меня длинная, порядка 15 метров витой пары. Подключение одиночными или скрученными по 4 проводами и заземление экрана никакого статистически заметного эффекта не давали.
Поэтому написал собственную программу управления по шине OpenTherm с использованием RMT.

Программа разбита на классы:
* class RMT_Opentherm осуществляет непосредственно обмен пакетами.
* class OT_Boiler реализует протокол OpenTherm с понадобившимися мне командами. Ведет статистику ошибок и повторяет при необходимости неудачные обмены.
* boiler_task в отдельной задаче реализует управление котлом, алгоритмов термостата и т.д.

Преимущества:
1. Не страдает многозадачность FreeRTOS, так как нет delay. OpenTherm – это довольно медленный протокол, отправка команды занимает целых 34 мс, которые можно потратить на более полезные вещи.
2. Простой приём. Задача уходит в ожидающий режим, позволяя работать остальным, и просыпается по событию завершения приёма. При этом появляется сразу весь сигнал в виде массива уровней и их длительности.
3. Надежность. Всё-таки, аппаратная поддержка позволяет не зависеть от загруженности контроллера другими задачами.

Результат:
1. Пропали ошибки обмена. Их количество сократилось примерно с 80 в сутки до одной за несколько дней. Но тут и котел грешить может.
2. Высвободились ресурсы процессора.

## Telegram bot
Реализован "врукопашную" https-запросами по официальной документации Telegram.

* выдает текущее состояние;
* выдает лог в формате .csv за текущие сутки;
* выполняет различные команды;
* использует серверы Telegram для хранения суточных логов;
* отправляет сообщения о нештатных ситуациях;
* выполняет прошивку устройства OTA, если отправить боту файл прошивки с заранее определенным именем от заранее определенного пользователя;
* ограниченивает пользователей "белым списком".

## Общие соображения
Задачи общего характера, такие как управление котлом, опрос датчиков температур, управление термоэлектрическими сервоприводами, выполняются на ядре №1. Задачи внешнего управления выполняются на ядре № 2. Таким образом, ожидания https-запросов к telegram или задержки в обработке команд TCP-сервера не влияют на основные задачи.

На Raspberry Pi 4 в локальной сети запущен mosquitto и свой веб-сервер на Flask + gunicorn + nginx. Основное управление, запись и хранение логов, построение графиков и прочее реализовано там. Telegram остался исторически, используется как резервный канал связи и для получения уведомлений.

В целом, получилась очень автономная система управления отоплением, не зависящая от платных сервисов. Пропадание Wi-Fi и Интернета переживает легко, после перезагрузки по питанию режимы управления восстанавливаются.

## License
Буду рад, если кому-то пригодится. Для меня это просто хобби.